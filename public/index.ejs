<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Zap da Trybe</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/3.0.4/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <form class="chat">
      <div id="user"></div>
      <div>
        <% if (onlineUsers) {%> <% onlineUsers.forEach(user => { %>
        <p data-testid="online-user" id="a<%=user.userId %>"><%= user.nickname%></p>
        <%})%> <% } %>
      </div>
      <div>
        <input
          data-testid="nickname-box"
          id="nickname"
          type="text"
          placeholder="Digite seu nickname"
        />
        <button data-testid="nickname-save" id="nickBtn" type="button">Trocar</button>
      </div>
      <div class="messages">
        <% if (messages) {%> <% messages.forEach(message => { %>
        <li data-testid="message">
          <%= message.date %> - <%= message.nickname %>: <%= message.chatMessage%>
        </li>
        <%})%> <% } %>
      </div>
      <div>
        <input
          data-testid="message-box"
          id="message"
          type="text"
          name="message"
          placeholder="Digite sua mensagem"
        />
        <button data-testid="send-button" id="submitBtn" type="button">Enviar</button>
      </div>
    </form>
  </body>
  <script>
    const socket = io();
    let nickInUse;
    let UserId;
    const nick = document.querySelector('#nickname');
    const nickBtn = document.querySelector('#nickBtn');
    const button = document.querySelector('#submitBtn');
    const msginput = document.querySelector('#message');
    const messages = document.querySelector('.messages');
    const user = document.querySelector('#user');

    /**

        sockets

    **/

    /**
      usu치rio logou
    **/
    socket.on('userLogedIn', (randomNick, userId) => {
      if (!UserId) {
        nickInUse = randomNick;
        UserId = userId;
      }
      const p = document.createElement('p');
      p.setAttribute('data-testid', 'online-user');
      p.setAttribute('id', `a${userId}`);
      p.innerHTML = randomNick;
      user.appendChild(p);
    });

    /**
      outro usu치rio trocou nick
    **/
    socket.on('anotherUserChangedNick', (nickname, userId) => {
      const p = document.querySelector(`#a${userId}`);
      p.innerHTML = nickname;
    });

    /**
      usu치rio enviou msg
    **/
    socket.on('message', (message) => {
      renderMessage(message);
    });

    /**
      Outro usu치rio desconectou
    **/

    socket.on('quit', (userId) => {
      console.log('quitou');
      const p = document.querySelector(`#a${userId}`);
      p.innerHTML = '';
      p.remove()
    });

    /**

        renderiza mensagem no chat

    **/
    function renderMessage(message) {
      const li = document.createElement('li');
      li.innerHTML = message;
      li.setAttribute('data-testid', 'message');
      messages.appendChild(li);
    }

    /**

        event listeners

    **/

    /**
      evento de trocar nick
    **/
    nickBtn.addEventListener('click', () => {
      if (nick.value.length) {
        nickInUse = nick.value;
        nick.value = '';
        const p = document.querySelector(`#a${UserId}`);
        p.innerHTML = nickInUse;
        socket.emit('nickChange', nickInUse);
      }
    });

    /**
      evento de enviar msg
    **/
    button.addEventListener('click', () => {
      if (msginput.value.length) {
        const chatMessage = msginput.value;
        const nickname = nickInUse;

        const dateTime = new Date().getTime();
        const date = moment(dateTime).format('DD-MM-yyyy h:mm:ss A');

        const sendMessage = { chatMessage, nickname, date };

        socket.emit('message', sendMessage);
        msginput.value = '';
      }
    });
  </script>
</html>
